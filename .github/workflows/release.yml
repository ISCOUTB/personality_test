name: Create Release Package

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      create_github_release:
        description: 'Create GitHub Release'
        required: true
        default: true
        type: boolean

jobs:
  create-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Get version from version.php
      id: get_version
      run: |
        # Extract version from version.php
        VERSION=$(grep -o "version = [0-9]*" version.php | grep -o "[0-9]*")
        RELEASE=$(grep -o "release.*=.*'[^']*'" version.php | grep -o "'[^']*'" | tr -d "'")
        COMMIT_SHORT=$(echo ${{ github.sha }} | cut -c1-7)
        TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "release=$RELEASE" >> $GITHUB_OUTPUT
        echo "commit_short=$COMMIT_SHORT" >> $GITHUB_OUTPUT
        echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
        echo "tag=v$RELEASE" >> $GITHUB_OUTPUT
        echo "auto_tag=v$RELEASE-auto-$COMMIT_SHORT" >> $GITHUB_OUTPUT
        
    - name: Create release directory
      run: |
        mkdir -p release/block_personality_test
        
    - name: Copy files to release directory
      run: |
        # Copy all files except .git and .github
        rsync -av --exclude='.git' --exclude='.github' --exclude='release' --exclude='build' . release/block_personality_test/
        
    - name: Create ZIP package
      run: |
        cd release
        zip -r "block_personality_test_v${{ steps.get_version.outputs.release }}.zip" block_personality_test/
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: block_personality_test_v${{ steps.get_version.outputs.release }}
        path: release/block_personality_test_v${{ steps.get_version.outputs.release }}.zip
        
    - name: Check if tag exists
      id: check_tag
      run: |
        if git rev-parse "refs/tags/${{ steps.get_version.outputs.tag }}" >/dev/null 2>&1; then
          echo "tag_exists=true" >> $GITHUB_OUTPUT
        else
          echo "tag_exists=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Create tag if not exists
      if: steps.check_tag.outputs.tag_exists == 'false'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag ${{ steps.get_version.outputs.tag }}
        git push origin ${{ steps.get_version.outputs.tag }}
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        name: Personality Test Block v${{ steps.get_version.outputs.version }}
        body: |
          ## Personality Test Block v${{ steps.get_version.outputs.version }}
          
          ### üß† **Bloque de Test de Personalidad MBTI para Moodle**
          
          Este bloque permite evaluar y visualizar los tipos de personalidad de los estudiantes basado en el modelo Myers-Briggs Type Indicator (MBTI).
          
          ### ‚ú® **Caracter√≠sticas Principales**
          - **Test MBTI Completo** con 70 preguntas
          - **Visualizaciones Interactivas** con Chart.js
          - **Exportaci√≥n PDF** de resultados detallados
          - **Dashboard de An√°lisis** para profesores
          - **Responsive Design** adaptado a dispositivos m√≥viles
          
          ### ÔøΩ **Dimensiones MBTI Evaluadas**
          - **Extroversi√≥n/Introversi√≥n** - Orientaci√≥n de energ√≠a
          - **Sensaci√≥n/Intuici√≥n** - Procesamiento de informaci√≥n
          - **Pensamiento/Sentimiento** - Toma de decisiones
          - **Juicio/Percepci√≥n** - Estilo de vida
          
          ### üîß **Instalaci√≥n**
          1. Descargar el archivo ZIP adjunto
          2. Extraer en `/blocks/personality_test/` en tu instalaci√≥n de Moodle
          3. Visitar la p√°gina de administraci√≥n para completar la instalaci√≥n
          4. Agregar el bloque a los cursos deseados
          
          ### üìä **Funcionalidades para Profesores**
          - Visualizaci√≥n de distribuci√≥n de tipos MBTI
          - Gr√°ficos por aspectos de personalidad
          - Exportaci√≥n de datos en PDF
          - An√°lisis estad√≠stico del curso
          
          ### ÔøΩÔ∏è **Seguridad y Permisos**
          - Control de acceso basado en capacidades de Moodle
          - Verificaci√≥n de sesi√≥n para todas las acciones
          - Protecci√≥n de datos de personalidad
          
          ---
          
          **Versi√≥n:** ${{ steps.get_version.outputs.version }}  
          **Compatibilidad:** Moodle 2.5+  
          **Desarrollado por:** SAVIO UTB  
          **Licencia:** GPL v3  
          
        draft: false
        prerelease: false
        files: personality_test_v${{ steps.get_version.outputs.version }}.zip
