<div class="block_personality_test_container">
    <style>
        #personality-test-results-region .page-item.active .page-link {
            background-color: #00bf91;
            border-color: #00bf91;
            color: white;
        }
        #personality-test-results-region .page-link {
            color: #00bf91;
        }
    </style>

    <h1 class="mb-4 text-center">
        <img src="{{{icon_url}}}" alt="Personality Test Icon" style="width: 50px; height: 50px; vertical-align: middle; margin-right: 15px;" />
        {{title}}
    </h1>
    <div class="alert alert-info mb-4">
        {{{ description }}}
    </div>

    {{#delete_confirmation}}
    <div class="alert alert-warning">
        <h4>{{#str}}confirm_delete, block_personality_test{{/str}}</h4>
        <p>{{confirm_message}}</p>
        <div class="mt-3">
            <a href="{{confirm_url}}" class="btn btn-danger text-white">{{#str}}confirm_delete_yes, block_personality_test{{/str}}</a>
            <a href="{{cancel_url}}" class="btn btn-secondary text-white">{{#str}}cancel, block_personality_test{{/str}}</a>
        </div>
    </div>
    {{/delete_confirmation}}

    {{^delete_confirmation}}
    <div class="row mb-4">
        <div class="col-md-3 mb-4">
            <div class="card border-info h-100" style="border-color: #00bf91 !important;">
                <div class="card-body text-center">
                    <i class="fa fa-users" style="font-size: 2em; margin-bottom: 10px; color: #00bf91;"></i>
                    <h5 class="card-title">{{#str}}total_students, block_personality_test{{/str}}</h5>
                    <h2 class="text-info" style="color: #00bf91 !important;">{{total_students}}</h2>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-4">
            <div class="card border-success h-100" style="border-color: #28a745 !important;">
                <div class="card-body text-center">
                    <i class="fa fa-check-circle text-success" style="font-size: 2em; margin-bottom: 10px;"></i>
                    <h5 class="card-title">{{#str}}completed_tests, block_personality_test{{/str}}</h5>
                    <h2 class="text-success">{{completed_tests}}</h2>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-4">
            <div class="card border-warning h-100" style="border-color: #ffc107 !important;">
                <div class="card-body text-center">
                    <i class="fa fa-clock-o" style="font-size: 2em; margin-bottom: 10px; color: #ffc107;"></i>
                    <h5 class="card-title">{{#str}}in_progress_tests, block_personality_test{{/str}}</h5>
                    <h2 class="text-info" style="color: #ffc107 !important;">{{in_progress_tests}}</h2>
                </div>
            </div>
        </div>

        <div class="col-md-3 mb-4">
            <div class="card border-primary h-100" style="border-color: #00bf91 !important;">
                <div class="card-body text-center">
                    <i class="fa fa-percent" style="font-size: 2em; margin-bottom: 10px; color: #00bf91;"></i>
                    <h5 class="card-title">{{#str}}completion_rate, block_personality_test{{/str}}</h5>
                    <h2 class="text-info" style="color: #00bf91 !important;">{{completion_rate}}%</h2>
                </div>
            </div>
        </div>
    </div>

    {{#has_completed}}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fa fa-chart-bar"></i> {{#str}}general_statistics, block_personality_test{{/str}}</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Most Common Types -->
                        <div class="col-md-5 mb-4">
                            <h6 class="text-center text-md-left mb-3">{{#str}}most_common_types, block_personality_test{{/str}}</h6>
                            <div class="row">
                                {{#top_types}}
                                <div class="col-6 mb-3">
                                    <div class="position-relative d-flex align-items-center bg-white p-2 rounded shadow-sm border border-light h-100 overflow-hidden" 
                                         style="border-left-width: 5px !important; border-left-color: {{color_hex}} !important;">
                                        <!-- Rank Watermark -->
                                        <div style="position: absolute; right: 10px; bottom: -10px; font-size: 5rem; font-weight: 900; color: #f4f4f4; z-index: 0; line-height: 1; pointer-events: none;">
                                            {{rank}}
                                        </div>
                                        
                                        <div class="d-flex flex-column align-items-center justify-content-center mr-2 ml-1" style="min-width: 50px; z-index: 1; position: relative;">
                                            <span class="h5 mb-0 font-weight-bold" style="color: {{color_hex}};">{{percentage}}%</span>
                                        </div>
                                        <div class="w-100 py-1 pl-2" style="border-left: 1px solid #eee; z-index: 1; position: relative;">
                                            <h6 class="mb-0 font-weight-bold text-dark" style="font-size: 0.9rem; word-break: break-word; hyphens: auto;">{{label}}</h6>
                                            <small class="text-muted">{{count}}</small>
                                        </div>
                                    </div>
                                </div>
                                {{/top_types}}
                            </div>
                            {{^top_types}}
                            <p class="text-muted">{{#str}}no_data_available, block_personality_test{{/str}}</p>
                            {{/top_types}}
                        </div>
                        
                        <!-- Average Dimensions -->
                        <div class="col-md-7">
                            <h6 class="text-center text-md-left mb-3">{{#str}}average_dimensions, block_personality_test{{/str}}</h6>
                            <div class="row">
                                {{#dimension_stats}}
                                <div class="col-md-6 mb-3">
                                    <ul class="list-group shadow-sm">
                                        <li class="list-group-item d-flex justify-content-between align-items-center py-2">
                                            <span style="color: {{left_color}}; font-weight: bold;">{{left_label}}</span>
                                            <span class="badge badge-light border" style="font-size: 0.9em;">{{left_avg}}</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center py-2">
                                            <span style="color: {{right_color}}; font-weight: bold;">{{right_label}}</span>
                                            <span class="badge badge-light border" style="font-size: 0.9em;">{{right_avg}}</span>
                                        </li>
                                    </ul>
                                </div>
                                {{/dimension_stats}}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {{/has_completed}}

    <div id="personality-test-results-region">
    {{#show_table}}
        <div class="card mt-5" id="participants-container">
            <div class="card-header">
                <h5 class="mb-0">{{#str}}participants_list, block_personality_test{{/str}}</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3 w-100 mx-0">
                    <div class="col-md-9 pl-0 pr-0 pr-md-2">
                         <form id="searchForm" method="get" action="{{admin_url}}" onsubmit="return false;" style="width: 100%;">
                            <input type="hidden" name="cid" value="{{courseid}}">
                            <div class="input-group" style="width: 100%;">
                                <input type="text" name="search" id="searchInput" class="form-control" placeholder="{{#str}}search_participant, block_personality_test{{/str}}" value="{{search_term}}" autocomplete="off">
                            </div>
                         </form>
                    </div>
                    <div class="col-md-3 text-end d-flex justify-content-center justify-content-md-end mt-3 mt-md-0 pr-0 pl-0 pl-md-2">
                        <div class="btn-group w-100">
                            <a href="{{csv_url}}" class="btn btn-success"><i class="fa fa-download mr-2"></i>{{#str}}export_csv, block_personality_test{{/str}}</a>
                            <a href="{{pdf_url}}" class="btn btn-primary"><i class="fa fa-file-pdf-o mr-2"></i>{{#str}}export_pdf, block_personality_test{{/str}}</a>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>{{#str}}student_name, block_personality_test{{/str}}</th>
                                <th>{{#str}}email, block_personality_test{{/str}}</th>
                                <th>{{#str}}status, block_personality_test{{/str}}</th>
                                <th>{{#str}}mbti_type, block_personality_test{{/str}}</th>
                                <th>{{#str}}test_date, block_personality_test{{/str}}</th>
                                <th>{{#str}}actions, block_personality_test{{/str}}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{#list}}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        {{{userpicture}}}
                                        <span class="ml-2 pl-2"><strong>{{fullname}}</strong></span>
                                    </div>
                                </td>
                                <td>{{email}}</td>
                                <td>
                                    {{#is_completed}}
                                    <span class="badge badge-success">{{#str}}completed_status, block_personality_test{{/str}}</span>
                                    {{/is_completed}}
                                    {{^is_completed}}
                                    <span class="badge badge-warning text-dark">{{#str}}in_progress_status, block_personality_test{{/str}}</span>
                                    <br><small class="text-muted">{{answered}}/72 {{#str}}questions, block_personality_test{{/str}}</small>
                                    {{/is_completed}}
                                </td>
                                <td>
                                    {{#mbti_type}}
                                        <strong>{{.}}</strong>
                                    {{/mbti_type}}
                                    {{^mbti_type}}<span class="text-muted">-</span>{{/mbti_type}}
                                </td>
                                <td>{{created_at}}</td>
                                <td>
                                    <a href="{{view_url}}" class="btn btn-sm btn-info mr-2" title="{{#str}}view_results, block_personality_test{{/str}}">
                                        <i class="fa fa-eye"></i> {{#str}}view, block_personality_test{{/str}}
                                    </a>
                                    <a href="{{delete_url}}" class="btn btn-sm btn-danger" title="{{#str}}delete_participation, block_personality_test{{/str}}">
                                        <i class="fa fa-trash"></i> {{#str}}delete, block_personality_test{{/str}}
                                    </a>
                                </td>
                            </tr>
                            {{/list}}
                            {{^list}}
                            <tr>
                                <td colspan="6" class="text-center p-4">
                                    <div class="alert alert-warning mb-0">
                                        <i class="fa fa-exclamation-triangle mr-2"></i> {{#str}}no_results_search, block_personality_test, {{search_term}}{{/str}}
                                    </div>
                                </td>
                            </tr>
                            {{/list}}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                 <div class="mt-3 d-flex justify-content-center">
                    {{{pagination}}}
                 </div>
            </div>
        </div>
    {{/show_table}}
    {{^show_table}}
        <div class="alert alert-info mt-4">
            <i class="fa fa-info-circle"></i> 
            <h5>{{#str}}no_participants, block_personality_test{{/str}}</h5>
            <p>{{#str}}no_participants_message, block_personality_test{{/str}}</p>
        </div>
    {{/show_table}}
    </div>
    {{/delete_confirmation}}

    <div class="mt-4 text-center">
        <a href="{{course_url}}" class="btn btn-secondary">
            <i class="fa fa-arrow-left"></i> {{#str}}back_to_course, block_personality_test{{/str}}
        </a>
    </div>
</div>

{{#js}}
require(['jquery'], function($) {
    var timeout = null;
    var container = $('#personality-test-results-region');

    // Dynamic Search (AJAX) Delegated
    container.on('input', '#searchInput', function() {
        var input = $(this);
        if (timeout) clearTimeout(timeout);
        var searchTerm = input.val();
        
        timeout = setTimeout(function() {
            loadResults(searchTerm, 0); 
        }, 300);
    });
    
    container.on('click', '.pagination a', function(e) {
        e.preventDefault();
        var href = $(this).attr('href');
        if (!href) return;
        
        var urlParams = new URLSearchParams(href.split('?')[1]);
        var page = urlParams.get('page') || 0;
        var searchTerm = container.find('#searchInput').val() || '';
        
        loadResults(searchTerm, page);
    });

    function loadResults(search, page) {
        var url = '{{admin_url}}';
        var data = {
            cid: {{courseid}},
            search: search,
            page: page,
            action: 'list'
        };

        container.css('opacity', '0.6');

        $.get(url, data, function(response) {
            var responseObj = $('<div>').html(response);
            var newContent = responseObj.find('#personality-test-results-region').html();
            
            if (newContent) {
                container.html(newContent);
                var input = container.find('#searchInput');
                if (input.length) {
                    input.focus();
                    var tmpStr = input.val();
                    input.val('');
                    input.val(tmpStr);
                }
            }
            container.css('opacity', '1');
        });
    }
});
{{/js}}
